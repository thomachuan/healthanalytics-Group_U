---
title: "coursework"
author: "Thea"
date: "2025-02-01"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE, results='hide'}
packages = (c("ipumsr", "dplyr", "ggplot2", "tidyr", "here", "rmdformats", "srvyr"))

## Now load or install&load all
package.check <- lapply(
  packages,
  FUN = function(x) {
    if (!require(x, character.only = TRUE)) {
      install.packages(x, dependencies = TRUE)
      library(x, character.only = TRUE)
    }
  }
)
```

```{r setup, include=True}
#set working documents
setwd("~/Desktop/health analytics/coursework")

#load package
library(ipumsr)

#read data
ddi <- read_ipums_ddi("usa_00007.xml")
data <- read_ipums_micro(ddi,data_file = "usa_00005.dat")

#check first 4 rows
head(data)
```

# **Data collection and cleaning**

```{r, include=TRUE}
#Create a subset that contains these variables
df <- data %>%
  select(NCHILD, UHRSWORK, AGE, INCTOT, EDUC, SEX) %>%
  filter(!is.na(UHRSWORK) & !is.na(NCHILD) & SEX == 2)

#summary of variable
summary(df)  

#Processing missing value
df <- df %>%
  drop_na()


#Visualize data
#woking hours

ggplot(df, aes(x = UHRSWORK)) +
  geom_histogram(bins = 30, fill = "skyblue", color = "black") +
  theme_minimal() +
  labs(title = "Distribution of Weekly Working Hours (Before Cleaning)", x = "Weekly Working Hours", y = "Count")

boxplot(df$UHRSWORK, main="Boxplot of Working Hours (Before Cleaning)", col="lightblue")

#income
ggplot(df, aes(x = INCTOT)) +
  geom_histogram(bins = 50, fill = "skyblue", color = "black") +
  theme_minimal() +
  labs(title = "Income Distribution (Before Cleaning)", x = "Total Income", y = "Count")

boxplot(df$INCTOT, main="Boxplot of Income (Before Cleaning)", col="skyblue")

#age
ggplot(df, aes(x = AGE)) +
  geom_histogram(bins = 30, fill = "skyblue", color = "black") +
  theme_minimal() +
  labs(title = "Age Distribution (Before Cleaning)", x = "Age", y = "Count")

boxplot(df$AGE, main="Boxplot of Age (Before Cleaning)", col="skyblue")

#education
ggplot(df, aes(x = EDUC)) +
  geom_bar(fill = "skyblue", color = "black") +
  theme_minimal() +
  labs(title = "Distribution of Education Levels", x = "Education Level", y = "Count")

#fetility
ggplot(df, aes(x = NCHILD)) +
  geom_histogram(bins = 30, fill = "skyblue", color = "black") +
  theme_minimal() +
  labs(title = "Fetility Distribution (Before Cleaning)", x = "number of child", y = "Count")

boxplot(df$AGE, main="Boxplot of fetility (Before Cleaning)", col="skyblue")

```

```{r, include=TRUE}
#cleaning data
# Calculate IQR and filter outliers (income)

Q1_income <- quantile(df$INCTOT, 0.25, na.rm = TRUE)
Q3_income <- quantile(df$INCTOT, 0.75, na.rm = TRUE)
IQR_income <- Q3_income - Q1_income
lower_income <- Q1_income - 1.5 * IQR_income
upper_income <- Q3_income + 1.5 * IQR_income

#Calculate IQR and filter outliers (fertility)
Q1_fertility <- quantile(df$NCHILD, 0.25, na.rm = TRUE)
Q3_fertility <- quantile(df$NCHILD, 0.75, na.rm = TRUE)
IQR_fertility <- Q3_fertility - Q1_fertility
lower_fertility <- Q1_fertility - 1.5 * IQR_fertility
upper_fertility <- Q3_fertility + 1.5 * IQR_fertility

#Calculate IQR and filter outliers (age)
Q1_age <- quantile(df$AGE, 0.25, na.rm = TRUE)
Q3_age <- quantile(df$AGE, 0.75, na.rm = TRUE)
IQR_age <- Q3_age - Q1_age
lower_age <- Q1_age - 1.5 * IQR_age
upper_age <- Q3_age + 1.5 * IQR_age

#data cleaning
df_cleaned <- df %>%
  filter(UHRSWORK > 0,  # remove zero working time
         AGE >= 18 & AGE <= 65,  # Filter ages 18 to 65
         AGE >= lower_age & AGE <= upper_age,  # Remove age extremes
         INCTOT >= lower_income & INCTOT <= upper_income,  # Remove income extremes
         NCHILD >= lower_fertility & NCHILD <= upper_fertility) %>%  #Filter fertility outliers
  mutate(
    log_INCTOT = log1p(INCTOT),  
    log_NCHILD = log1p(NCHILD),  
    EDUC = case_when( 
      EDUC <= 2 ~ "No School",
      EDUC %in% c(3, 4, 5) ~ "High School",
      EDUC %in% c(6, 7, 8) ~ "College",
      EDUC >= 9 ~ "Graduate"
    )
  )

#Visualize distribution (after cleaning)
ggplot(df_cleaned, aes(x = AGE)) +
  geom_histogram(bins = 30, fill = "green", color = "black") +
  theme_minimal() +
  labs(title = "Age Distribution (After Cleaning)", x = "Age", y = "Count")

ggplot(df_cleaned, aes(x = log_INCTOT)) +
  geom_histogram(bins = 50, fill = "green", color = "black") +
  theme_minimal() +
  labs(title = "Income Distribution (After Cleaning)", x = "Log Total Income", y = "Count")

ggplot(df_cleaned, aes(x = log_NCHILD)) +
  geom_histogram(bins = 30, fill = "green", color = "black") +
  theme_minimal() +
  labs(title = "Fertility Distribution (After Cleaning)", x = "Log Number of Children", y = "Count")


ggplot(df_cleaned, aes(x = UHRSWORK)) +
  geom_histogram(bins = 30, fill = "green", color = "black") +
  theme_minimal() +
  labs(title = "Weekly Working Hours Distribution (After Cleaning)", x = "Weekly Working Hours", y = "Count")


```

```{r, include=TRUE}

df_cleaned$EDUC <- factor(df_cleaned$EDUC, levels = c("No School", "High School", "College", "Graduate"))

# 使用 model.matrix 创建 dummy 变量
df_cleaned <- df_cleaned %>%
  mutate(
    EDUC_No_School = if_else(EDUC == "No School", 1, 0),
    EDUC_High_School = if_else(EDUC == "High School", 1, 0),
    EDUC_College = if_else(EDUC == "College", 1, 0),
    EDUC_Graduate = if_else(EDUC == "Graduate", 1, 0)
  )

head(df_cleaned)

#regression
model <- lm(log_NCHILD ~ UHRSWORK + log_INCTOT + AGE + EDUC_High_School + EDUC_College + EDUC_Graduate, data = df_cleaned)
summary(model)
```

```{r residual-plot}
# Extract residuals and fitted values
residuals<- data.frame(
  Fitted = fitted(model),
  Residuals = residuals(model)
)

# Plot residuals
residuals %>%
  ggplot(aes(x = Fitted, y = Residuals)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Residual Plot: Multivariate Regression",
    x = "Fitted Values",
    y = "Residuals"
  )
```

```{r residual-plot}

# 步骤 1：检验 UHRSWORK 对 log_INCTOT 的影响
model_1 <- lm(log_INCTOT ~ UHRSWORK, data = df_cleaned)
summary(model_1)

# 步骤 2：检验 log_INCTOT 对 log_NCHILD 的影响
model_2 <- lm(log_NCHILD ~ log_INCTOT, data = df_cleaned)
summary(model_2)

# 步骤 3：检验 UHRSWORK 对 log_NCHILD 的影响，如果不控制 log_INCTOT
model_3 <- lm(log_NCHILD ~ UHRSWORK + AGE + EDUC_High_School + EDUC_College + EDUC_Graduate, data = df_cleaned)
summary(model_3)


# Create residuals dataframe
residuals_3 <- data.frame(
  Fitted_3 = fitted(model_3),
  Residuals_3 = residuals(model_3)
)

# Plot residuals
residuals_3 %>%
  ggplot(aes(x = Fitted_3, y = Residuals_3)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Residual Plot: Multivariate Regression_3",
    x = "Fitted Values",
    y = "Residuals"
  )
```
